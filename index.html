<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Typing Game</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
    }
    .sentence {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1rem;
    }
    input[type="text"] {
      width: 100%;
      font-size: 1rem;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    .typing-input {
      height: 100px;
      font-family: monospace;
    }
    .result {
      margin-top: 1rem;
    }
    .leaderboard {
      margin-top: 2rem;
    }
    .leaderboard h3 {
      margin-bottom: 0.5rem;
    }
    ol {
      padding-left: 1.5rem;
    }
  </style>
</head>
<body>
  <h1>Typing Challenge</h1>
  <div class="sentence" id="targetSentence">
    Betty Botter bought some butter, but Betty Botter thought her butter was bitter, so she bought some better butter to make her butter better.
  </div>

  <input type="text" id="playerName" placeholder="Enter your name">
  <input type="text" id="inputField" class="typing-input" placeholder="Type the sentence above and press Enter when done..." autocomplete="off">
  <div class="result" id="result"></div>

  <div class="leaderboard">
    <h3>Leaderboard (Top 5)</h3>
    <ol id="leaderboard"></ol>
  </div>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://vcdrdwdhleiauccimdrm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjZHJkd2RobGVpYXVjY2ltZHJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0Njk0NzAsImV4cCI6MjA2NjA0NTQ3MH0.9bfXvPlXaPgCTYr7kPqwfqScsCNfkO2MtAgDbsw_GRY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM elements
    const targetSentence = document.getElementById('targetSentence').innerText;
    const inputField = document.getElementById('inputField');
    const result = document.getElementById('result');
    const leaderboardList = document.getElementById('leaderboard');
    const playerNameInput = document.getElementById('playerName');

    // Game state
    let startTime = null;
    let hasStarted = false;
    let totalKeystrokes = 0;
    let realTimeMistakes = 0;

    // Prevent cheating
    inputField.addEventListener('contextmenu', e => e.preventDefault());
    inputField.addEventListener('paste', e => e.preventDefault());
    inputField.addEventListener('drop', e => e.preventDefault());

    // Typing tracking
    inputField.addEventListener('input', () => {
      if (!hasStarted && inputField.value.length > 0) {
        hasStarted = true;
        startTime = Date.now();
        totalKeystrokes = 0;
        realTimeMistakes = 0;
      }

      const currentInput = inputField.value;
      const expectedChar = targetSentence[currentInput.length - 1];
      const typedChar = currentInput[currentInput.length - 1];

      if (expectedChar !== typedChar) {
        realTimeMistakes++;
      }

      totalKeystrokes++;
    });

    // Score submission on Enter key
    inputField.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        
        const name = playerNameInput.value.trim();
        const typed = inputField.value.trim();

        if (!name) {
          alert("Please enter your name.");
          return;
        }

        if (!typed) {
          alert("Please type something before submitting.");
          return;
        }

        if (!hasStarted) {
          alert("Please start typing first.");
          return;
        }

        const endTime = Date.now();
        const timeInSeconds = (endTime - startTime) / 1000;

        // Calculate mistakes
        let finalMistakes = 0;
        const minLength = Math.min(typed.length, targetSentence.length);
        for (let i = 0; i < minLength; i++) {
          if (typed[i] !== targetSentence[i]) finalMistakes++;
        }
        finalMistakes += Math.abs(typed.length - targetSentence.length);

        // Calculate score
        const accuracy = totalKeystrokes > 0 ? Math.max(0, 1 - (realTimeMistakes / totalKeystrokes)) : 0;
        const accuracyPenalty = (1 - accuracy) * 5;
        const penalty = finalMistakes * 0.5 + accuracyPenalty;
        const score = Math.max(0, (timeInSeconds - penalty)).toFixed(2);

        // Display results
        result.innerHTML = `
          Time: ${timeInSeconds.toFixed(2)}s<br>
          Total Keystrokes: ${totalKeystrokes}<br>
          Mistakes During Typing: ${realTimeMistakes}<br>
          Accuracy: ${(accuracy * 100).toFixed(1)}%<br>
          <strong>Score: ${score}</strong>
        `;

        // Save to Supabase
        try {
          const { data, error } = await supabase
            .from('leaderboard')
            .insert([{ 
              player_name: name, 
              score: parseFloat(score),
              submitted_at: new Date().toISOString()
            }]);
          
          if (error) throw error;
          updateLeaderboard();
        } catch (error) {
          console.error("Error saving to Supabase:", error);
          result.innerHTML += `<br><span style="color:red">Error saving to leaderboard</span>`;
        }

        // Reset game state
        hasStarted = false;
        startTime = null;
        inputField.value = '';
        totalKeystrokes = 0;
        realTimeMistakes = 0;
        inputField.focus();
      }
    });

    // Leaderboard management
    async function updateLeaderboard() {
      try {
        const { data, error } = await supabase
          .from('leaderboard')
          .select('*')
          .order('score', { ascending: true })
          .limit(5);
        
        if (error) throw error;

        leaderboardList.innerHTML = '';
        if (data) {
          data.forEach(entry => {
            const li = document.createElement('li');
            li.textContent = `${entry.player_name}: ${entry.score.toFixed(2)}s`;
            leaderboardList.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Error fetching leaderboard:", error);
        leaderboardList.innerHTML = '<li>Error loading leaderboard</li>';
      }
    }

    // Initialize
    updateLeaderboard();
    inputField.focus();
  </script>
</body>
</html>
